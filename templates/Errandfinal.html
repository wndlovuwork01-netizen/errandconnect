<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ErrandFinal - Finalize Errand Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fdf8;
            height: 100vh;
            font-size: 16px;
        }

        .errand-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Header Styles - Green Theme for both Client and Runner */
        .errand-header {
            color: white;
            padding: 15px;
        }

        .client-view .errand-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 2px 15px rgba(40, 167, 69, 0.3);
        }

        .runner-view .errand-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 2px 15px rgba(40, 167, 69, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .errand-info {
            flex: 1;
            text-align: center;
        }

        .errand-title {
            margin: 0;
            font-size: 18px;
            color: white;
            font-weight: 600;
        }

        .errand-meta {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.9;
        }

        .price-info {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 5px;
            font-size: 13px;
            font-weight: 500;
        }

        .price-item-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .price-value-header {
            font-weight: bold;
        }

        .system-price-header {
            color: #e8f5e8;
        }

        .runner-price-header {
            color: #e8f5e8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .user-role {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        /* Font Size Controls */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .font-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .font-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fdf8;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Message Styles */
        .message {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 20px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 8px;
        }

        .client-view .message.sent {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .runner-view .message.sent {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .message.received {
            align-self: flex-start;
            background: #95a5a6;
            color: white;
            border: 1px solid #7f8c8d;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .message.system-message {
            align-self: center;
            max-width: 90%;
            text-align: center;
            border-radius: 15px;
            font-weight: 500;
        }

        .client-view .message.system-message {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }

        .runner-view .message.system-message {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }

        .message.fee-proposal {
            border-radius: 15px;
            max-width: 85%;
        }

        .client-view .message.fee-proposal {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
        }

        .runner-view .message.fee-proposal {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
        }

        .fee-proposal-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fee-amount {
            font-size: 20px;
            font-weight: bold;
        }

        .client-view .fee-amount {
            color: #28a745;
        }

        .runner-view .fee-amount {
            color: #28a745;
        }

        .fee-label {
            font-size: 14px;
            font-weight: 500;
        }

        .client-view .fee-label {
            color: #2e7d32;
        }

        .runner-view .fee-label {
            color: #2e7d32;
        }

        .fee-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .fee-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .fee-action-btn.accept {
            background: #28a745;
            color: white;
        }

        .fee-action-btn.accept:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .fee-action-btn.counter {
            background: #ffc107;
            color: #333;
        }

        .fee-action-btn.counter:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .fee-action-btn.reject {
            background: #dc3545;
            color: white;
        }

        .fee-action-btn.reject:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* Final Agreement Bubbles */
        .agreement-bubble {
            max-width: 85%;
            padding: 20px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 10px 0;
        }

        .agreement-bubble.sent {
            align-self: flex-end;
        }

        .agreement-bubble.received {
            align-self: flex-start;
        }

        .client-view .agreement-bubble.sent {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
        }

        .runner-view .agreement-bubble.sent {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 1px solid #c8e6c9;
        }

        .client-view .agreement-bubble.received {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border: 1px solid #6c7b7d;
        }

        .runner-view .agreement-bubble.received {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border: 1px solid #6c7b7d;
        }

        .agreement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .agreement-header h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .client-view .agreement-bubble.sent .agreement-header h4 {
            color: #2e7d32;
        }

        .runner-view .agreement-bubble.sent .agreement-header h4 {
            color: #2e7d32;
        }

        .client-view .agreement-bubble.received .agreement-header h4 {
            color: white;
        }

        .runner-view .agreement-bubble.received .agreement-header h4 {
            color: white;
        }

        .agreement-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
        }

        .agreement-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .agreement-status.accepted {
            font-weight: bold;
        }

        .client-view .agreement-bubble.sent .agreement-status.accepted {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .runner-view .agreement-bubble.sent .agreement-status.accepted {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .agreed-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: white;
        }

        .agreed-price .price-label {
            font-size: 16px;
            font-weight: 600;
        }

        .client-view .agreement-bubble.sent .agreed-price .price-label {
            color: #2e7d32;
        }

        .runner-view .agreement-bubble.sent .agreed-price .price-label {
            color: #2e7d32;
        }

        .agreed-price .price-value {
            font-size: 24px;
            font-weight: 700;
        }

        .client-view .agreement-bubble.sent .agreed-price .price-value {
            color: #28a745;
        }

        .runner-view .agreement-bubble.sent .agreed-price .price-value {
            color: #28a745;
        }

        .agreement-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Payment Section with Animation */
        .payment-section {
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            display: none;
            transform: scale(0.8) translateY(-50px);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .payment-section.show {
            display: block;
            transform: scale(1) translateY(0);
            opacity: 1;
            animation: paymentFlyIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes paymentFlyIn {
            0% {
                transform: scale(0.5) translateY(-100px);
                opacity: 0;
            }
            60% {
                transform: scale(1.05) translateY(10px);
                opacity: 0.8;
            }
            80% {
                transform: scale(0.98) translateY(-5px);
                opacity: 0.9;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes paymentPopUp {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            70% {
                transform: scale(0.95);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .client-view .payment-section {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border: 2px solid #c8e6c9;
        }

        .runner-view .payment-section {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border: 2px solid #c8e6c9;
        }

        .payment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-header h4 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .client-view .payment-header h4 {
            color: #155724;
        }

        .runner-view .payment-header h4 {
            color: #155724;
        }

        .success {
            font-size: 24px;
        }

        .client-view .success {
            color: #28a745;
        }

        .runner-view .success {
            color: #28a745;
        }

        .final-amount-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .client-view .final-amount-display {
            border: 2px solid #28a745;
        }

        .runner-view .final-amount-display {
            border: 2px solid #28a745;
        }

        .final-amount-display span {
            font-size: 18px;
            font-weight: 600;
        }

        .client-view .final-amount-display span {
            color: #2e7d32;
        }

        .runner-view .final-amount-display span {
            color: #2e7d32;
        }

        .final-amount-display strong {
            font-size: 32px;
            font-weight: 700;
        }

        .client-view .final-amount-display strong {
            color: #28a745;
        }

        .runner-view .final-amount-display strong {
            color: #28a745;
        }

        /* Footer Styles */
        .chat-footer {
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .client-view .chat-footer {
            border-top: 2px solid #e8f5e8;
        }

        .runner-view .chat-footer {
            border-top: 2px solid #e8f5e8;
        }

        .quick-prices-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 8px 0;
        }

        .quick-label {
            font-size: 14px;
            font-weight: 500;
        }

        .client-view .quick-label {
            color: #28a745;
        }

        .runner-view .quick-label {
            color: #28a745;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .quick-prices.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .quick-prices-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            transition: all 0.3s;
            overflow: hidden;
        }

        .quick-prices.collapsed .quick-prices-content {
            height: 0;
            opacity: 0;
        }

        .price-suggestion-btn {
            padding: 8px 16px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .client-view .price-suggestion-btn {
            border: 2px solid #28a745;
            color: #28a745;
        }

        .runner-view .price-suggestion-btn {
            border: 2px solid #28a745;
            color: #28a745;
        }

        .price-suggestion-btn:hover {
            transform: translateY(-2px);
        }

        .client-view .price-suggestion-btn:hover {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .runner-view .price-suggestion-btn:hover {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .message-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .attach-btn {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-size: 18px;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            transition: all 0.3s;
        }

        .client-view .attach-btn {
            color: #28a745;
        }

        .runner-view .attach-btn {
            color: #28a745;
        }

        .attach-btn:hover {
            color: white;
            transform: scale(1.05);
        }

        .client-view .attach-btn:hover {
            background: #28a745;
        }

        .runner-view .attach-btn:hover {
            background: #28a745;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input, .amount-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s;
        }

        .client-view .message-input,
        .client-view .amount-input {
            border: 2px solid #e8f5e8;
            background: #f8fdf8;
        }

        .runner-view .message-input,
        .runner-view .amount-input {
            border: 2px solid #e8f5e8;
            background: #f8fdf8;
        }

        .message-input:focus, .amount-input:focus {
            background: white;
        }

        .client-view .message-input:focus,
        .client-view .amount-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .runner-view .message-input:focus,
        .runner-view .amount-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .amount-input-wrapper {
            position: relative;
            display: none;
        }

        .amount-input-wrapper .currency-symbol {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            font-size: 16px;
        }

        .client-view .amount-input-wrapper .currency-symbol {
            color: #28a745;
        }

        .runner-view .amount-input-wrapper .currency-symbol {
            color: #28a745;
        }

        .amount-input-wrapper .amount-input {
            padding-left: 35px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .price-proposal-btn {
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .price-proposal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .client-view .price-proposal-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .runner-view .price-proposal-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .send-btn {
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .client-view .send-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .runner-view .send-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        /* Button Styles */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .client-view .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .runner-view .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-outline {
            background: white;
            border: 2px solid;
        }

        .client-view .btn-outline {
            color: #28a745;
            border-color: #28a745;
        }

        .runner-view .btn-outline {
            color: #28a745;
            border-color: #28a745;
        }

        .btn-outline:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .client-view .btn-outline:hover {
            background: #f8fdf8;
        }

        .runner-view .btn-outline:hover {
            background: #f8fdf8;
        }

        .btn-success {
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .client-view .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .runner-view .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .client-view .modal-content {
            border: 1px solid #d4edda;
        }

        .runner-view .modal-content {
            border: 1px solid #d4edda;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            border-bottom: 2px solid;
            border-radius: 20px 20px 0 0;
        }

        .client-view .modal-header {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border-bottom-color: #e8f5e8;
        }

        .runner-view .modal-header {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border-bottom-color: #e8f5e8;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .client-view .modal-header h3 {
            color: #2e7d32;
        }

        .runner-view .modal-header h3 {
            color: #2e7d32;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .client-view .close-btn {
            color: #28a745;
        }

        .runner-view .close-btn {
            color: #28a745;
        }

        .close-btn:hover {
            transform: scale(1.1);
        }

        .client-view .close-btn:hover {
            color: #1e7e34;
        }

        .runner-view .close-btn:hover {
            color: #1e7e34;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 15px;
        }

        .client-view .form-group label {
            color: #2e7d32;
        }

        .runner-view .form-group label {
            color: #2e7d32;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .client-view .form-control {
            border-color: #e8f5e8;
            background: #f8fdf8;
        }

        .runner-view .form-control {
            border-color: #e8f5e8;
            background: #f8fdf8;
        }

        .form-control:focus {
            background: white;
        }

        .client-view .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .runner-view .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .price-input-group {
            position: relative;
        }

        .price-input-group .currency-symbol {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            font-size: 16px;
        }

        .client-view .price-input-group .currency-symbol {
            color: #28a745;
        }

        .runner-view .price-input-group .currency-symbol {
            color: #28a745;
        }

        .price-input-group .form-control {
            padding-left: 35px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* QR Modal */
        .qr-modal {
            max-width: 350px;
        }

        .qr-amount-display {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid;
        }

        .client-view .qr-amount-display {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border-color: #d4edda;
        }

        .runner-view .qr-amount-display {
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
            border-color: #d4edda;
        }

        .qr-amount-display span {
            font-size: 16px;
            font-weight: 600;
        }

        .client-view .qr-amount-display span {
            color: #2e7d32;
        }

        .runner-view .qr-amount-display span {
            color: #2e7d32;
        }

        .qr-amount-display strong {
            font-size: 28px;
            display: block;
            margin-top: 8px;
            font-weight: 700;
        }

        .client-view .qr-amount-display strong {
            color: #28a745;
        }

        .runner-view .qr-amount-display strong {
            color: #28a745;
        }

        .qr-code-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            min-height: 256px;
            align-items: center;
        }

        .qr-placeholder {
            text-align: center;
            padding: 40px;
            border-radius: 15px;
            border: 2px dashed;
            width: 100%;
        }

        .client-view .qr-placeholder {
            color: #28a745;
            background: #f8fdf8;
            border-color: #d4edda;
        }

        .runner-view .qr-placeholder {
            color: #28a745;
            background: #f8fdf8;
            border-color: #d4edda;
        }

        .qr-placeholder i {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .client-view .qr-placeholder i {
            color: #c8e6c9;
        }

        .runner-view .qr-placeholder i {
            color: #c8e6c9;
        }

        .payment-instructions {
            text-align: center;
            font-size: 13px;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 10px;
        }

        .client-view .payment-instructions {
            color: #2e7d32;
            background: #e8f5e8;
        }

        .runner-view .payment-instructions {
            color: #2e7d32;
            background: #e8f5e8;
        }

        /* Real QR Code Styling */
        .real-qr-code {
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 10px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .qr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        /* Price Guidance in Modal */
        .price-guidance {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid;
        }

        .client-view .price-guidance {
            background: #f8fdf8;
            border-color: #d4edda;
        }

        .runner-view .price-guidance {
            background: #f8fdf8;
            border-color: #d4edda;
        }

        .guidance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid;
        }

        .client-view .guidance-item {
            border-bottom-color: #e8f5e8;
        }

        .runner-view .guidance-item {
            border-bottom-color: #e8f5e8;
        }

        .guidance-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Role-based display classes */
        .client-only { display: none; }
        .runner-only { display: none; }

        .client-view .client-only { display: block; }
        .client-view .runner-only { display: none; }

        .runner-view .runner-only { display: block; }
        .runner-view .client-only { display: none; }

        /* QR Scanner Styles */
        .qr-scanner-container {
            text-align: center;
            padding: 20px;
        }

        .scanner-placeholder {
            padding: 40px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .scanner-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        #qrScanner {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            border: 2px solid #28a745;
        }

        /* Font Size Classes */
        .font-small {
            font-size: 14px;
        }

        .font-medium {
            font-size: 16px;
        }

        .font-large {
            font-size: 18px;
        }

        .font-xlarge {
            font-size: 20px;
        }

        /* Navigation Button */
        .nav-to-chats-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            transition: all 0.3s;
        }

        .nav-to-chats-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .nav-to-chats-btn i {
            margin-right: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .errand-container {
                height: 100vh;
            }

            .message {
                max-width: 85%;
            }

            .agreement-bubble {
                max-width: 90%;
            }

            .agreement-details {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .agreement-actions {
                width: 100%;
                justify-content: space-between;
            }

            .quick-prices-content {
                justify-content: center;
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .price-proposal-btn {
                font-size: 13px;
                padding: 10px 16px;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }

            .price-info {
                flex-direction: column;
                gap: 5px;
            }

            .nav-to-chats-btn {
                bottom: 80px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="errand-container" id="mainContainer">
        <!-- Header with Errand Info and Pricing -->
        <header class="errand-header">
            <div class="header-content">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="errand-info">
                    <h3 class="errand-title" id="errandTitle">Grocery Shopping</h3>
                    <div class="errand-meta">
                        <span class="meta-item"><i class="fas fa-road"></i> <span id="distance">5.2 km</span></span>
                        <span class="meta-item"><i class="fas fa-box"></i> <span id="size">Medium</span></span>
                        <span class="meta-item"><i class="fas fa-clock"></i> <span id="time">45 min</span></span>
                    </div>
                    <div class="price-info">
                        <div class="price-item-header">
                            <i class="fas fa-calculator"></i>
                            <span>Est. Cost: </span>
                            <span class="price-value-header system-price-header" id="estimatedCost">$25.00</span>
                        </div>
                        <div class="price-item-header">
                            <i class="fas" id="priceIcon"></i>
                            <span id="headerPriceLabel">Price: </span>
                            <span class="price-value-header runner-price-header" id="counterpartyPrice">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="font-controls">
                        <button class="font-btn" id="fontSmallBtn" title="Decrease Font Size">
                            A<sup>-</sup>
                        </button>
                        <button class="font-btn" id="fontLargeBtn" title="Increase Font Size">
                            A<sup>+</sup>
                        </button>
                    </div>
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=Client+User&background=28a745&color=fff"
                         alt="User" class="user-avatar">
                    <span class="user-role" id="userRole">Client</span>
                </div>
            </div>
        </header>

        <!-- Chat Messages Area -->
        <main class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- System Welcome Message -->
                <div class="message system-message">
                    <div class="message-text">
                        <strong>System:</strong> <span id="welcomeMessage">You're now connected with your runner! Discuss the errand details and agree on the final price.</span>
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="payment-section" id="paymentSection">
                <div class="payment-header">
                    <i class="fas fa-check-circle success"></i>
                    <h4>Price Agreement Reached!</h4>
                </div>
                <div class="payment-details">
                    <div class="final-amount-display">
                        <span id="paymentLabel">Final Amount:</span>
                        <strong id="finalAmount">$0.00</strong>
                    </div>
                    <div class="payment-actions">
                        <!-- Client sees QR Generation -->
                        <button class="btn btn-success client-only" id="generateQRBtn">
                            <i class="fas fa-qrcode"></i>
                            <span>Generate Payment QR Code</span>
                        </button>

                        <!-- Runner sees QR Scanning -->
                        <button class="btn btn-success runner-only" id="scanQRBtn">
                            <i class="fas fa-camera"></i>
                            <span>Scan Client's QR Code</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Message Input & Actions -->
        <footer class="chat-footer">
            <!-- Quick Price Suggestions -->
            <div class="quick-prices" id="quickPrices">
                <div class="quick-prices-header" id="quickPricesHeader">
                    <span class="quick-label">Quick Suggestions</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="quick-prices-content">
                    <button class="price-suggestion-btn" data-price="20">$20</button>
                    <button class="price-suggestion-btn" data-price="25">$25</button>
                    <button class="price-suggestion-btn" data-price="30">$30</button>
                    <button class="price-suggestion-btn" data-price="35">$35</button>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <button class="attach-btn" id="attachBtn">
                    <i class="fas fa-paperclip"></i>
                </button>

                <div class="input-wrapper">
                    <input type="text"
                           class="message-input"
                           id="messageInput"
                           placeholder="Type your message or suggest a price...">

                    <!-- Amount Input (shown when proposing fee) -->
                    <div class="amount-input-wrapper" id="amountInputWrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number"
                               class="amount-input"
                               id="amountInput"
                               placeholder="0.00"
                               min="0"
                               step="0.01">
                    </div>
                </div>

                <div class="action-buttons">
                    <!-- Proposal Button -->
                    <button class="price-proposal-btn" id="priceProposalBtn">
                        <i class="fas fa-dollar-sign"></i>
                        <span id="proposalButtonText">Propose Price</span>
                    </button>

                    <!-- Send Message Button -->
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Navigation to Chat List Button -->
    <button class="nav-to-chats-btn" id="navToChatsBtn" title="Go to Chat List">
        <i class="fas fa-comments"></i>
    </button>

    <!-- Price Proposal Modal -->
    <div class="modal" id="priceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Propose New Price</h3>
                <button class="close-btn" id="closePriceModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="price-guidance">
                    <div class="guidance-item">
                        <span>System Estimate:</span>
                        <strong>$25.00</strong>
                    </div>
                    <div class="guidance-item">
                        <span id="otherPartyPriceLabel">Client's Preferred Price:</span>
                        <strong id="otherPartyPrice">$2.00</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label for="proposedPrice" id="proposalLabel">Your Proposed Price:</label>
                    <div class="price-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number"
                               id="proposedPrice"
                               class="form-control"
                               placeholder="0.00"
                               min="0"
                               step="0.01">
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="cancelPriceBtn">Cancel</button>
                    <button class="btn btn-primary" id="submitPriceBtn">Send Proposal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content qr-modal">
            <div class="modal-header">
                <h3 id="qrModalTitle">Payment</h3>
                <button class="close-btn" id="closeQRModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-amount-display">
                    <span id="qrAmountLabel">Amount:</span>
                    <strong id="qrAmount">$0.00</strong>
                </div>

                <!-- Client sees QR Generation -->
                <div class="client-only" id="clientQRContent">
                    <div class="qr-code-container" id="qrCodeContainer">
                        <div class="qr-placeholder" id="qrPlaceholder">
                            <i class="fas fa-qrcode"></i>
                            <p>QR Code will appear here</p>
                        </div>
                    </div>
                    <div class="qr-actions" id="qrActions" style="display: none;">
                        <button class="btn btn-outline" id="downloadQRBtn">
                            <i class="fas fa-download"></i> Download QR
                        </button>
                        <button class="btn btn-primary" id="shareQRBtn">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                    <div class="payment-instructions">
                        <p><i class="fas fa-info-circle"></i> The runner will scan this QR code</p>
                    </div>
                </div>

                <!-- Runner sees QR Scanner -->
                <div class="runner-only" id="runnerQRContent">
                    <div class="qr-scanner-container">
                        <div class="scanner-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>Point camera at client's QR code</p>
                            <div class="scanner-actions">
                                <button class="btn btn-outline" id="uploadQRBtn">
                                    <i class="fas fa-upload"></i> Upload QR Image
                                </button>
                                <button class="btn btn-primary" id="startCameraBtn">
                                    <i class="fas fa-video"></i> Start Camera
                                </button>
                            </div>
                        </div>
                        <video id="qrScanner" style="display: none;"></video>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-success" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        <span id="confirmButtonText">Confirm</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ErrandFinalChat {
            constructor() {
                this.messages = [];
                this.estimatedCost = 25.00;
                this.clientPrice = 20.00;
                this.runnerPrice = 30.00;
                this.agreedPrice = 0;
                this.isPriceAgreed = false;
                this.isProposingFee = false;
                this.currentFontSize = 'medium';
                this.quickPricesCollapsed = false;
                this.systemMessageAdded = false;
                this.clientAgreement = { price: 0, status: 'pending' };
                this.runnerAgreement = { price: 0, status: 'pending' };
                this.generatedQRCode = null;

                // GET USER TYPE FROM URL PARAMETERS
                this.currentRole = this.getUserTypeFromURL();

                // GET ERAND DATA FROM URL PARAMETERS
                this.errandData = this.getErrandDataFromURL();

                this.initializeEventListeners();
                this.loadInitialMessages();
                this.updateUIForRole();
                this.applyFontSize(this.currentFontSize);

                // Update errand info from URL parameters
                this.updateErrandInfoFromURL();
            }

            getUserTypeFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const role = urlParams.get('role');

                if (role === 'runner' || role === 'client') {
                    return role;
                }

                // If no role specified, check if we have runner_price parameter (indicates runner)
                const runnerPrice = urlParams.get('runner_price');
                if (runnerPrice) {
                    return 'runner';
                }

                // Default to client if no parameters
                return 'client';
            }

            getErrandDataFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const data = {
                    errandId: urlParams.get('errand_id') || '1',
                    runnerId: urlParams.get('runner_id') || 'runner123',
                    runnerName: urlParams.get('runner_name') || 'Runner Smith',
                    runnerPrice: parseFloat(urlParams.get('runner_price')) || 25.00,
                    clientPrice: parseFloat(urlParams.get('client_price')) || 20.00,
                    errandTitle: urlParams.get('errand_title') || 'Grocery Shopping',
                    action: urlParams.get('action') || 'chat',
                    role: urlParams.get('role') || 'client'
                };

                // Set initial prices based on URL parameters
                if (data.runnerPrice > 0) {
                    this.runnerPrice = data.runnerPrice;
                }
                if (data.clientPrice > 0) {
                    this.clientPrice = data.clientPrice;
                }

                return data;
            }

            updateErrandInfoFromURL() {
                // Update the errand title from URL parameters
                if (this.errandData.errandTitle) {
                    document.getElementById('errandTitle').textContent = this.errandData.errandTitle;
                }

                // Update prices display
                document.getElementById('counterpartyPrice').textContent =
                    this.currentRole === 'runner' ?
                    `$${this.clientPrice.toFixed(2)}` :
                    `$${this.runnerPrice.toFixed(2)}`;

                // Update guidance in modal
                document.getElementById('otherPartyPrice').textContent =
                    this.currentRole === 'runner' ?
                    `$${this.clientPrice.toFixed(2)}` :
                    `$${this.runnerPrice.toFixed(2)}`;

                // If action is 'accepted', show payment section immediately
                if (this.errandData.action === 'accepted' && this.errandData.runnerPrice) {
                    this.agreedPrice = this.errandData.runnerPrice;
                    this.isPriceAgreed = true;
                    this.showPaymentSection();
                    this.addSystemMessage("Errand accepted! Price agreed at $" + this.agreedPrice.toFixed(2));
                }
            }

            initializeEventListeners() {
                document.getElementById('fontSmallBtn').addEventListener('click', () => this.decreaseFontSize());
                document.getElementById('fontLargeBtn').addEventListener('click', () => this.increaseFontSize());
                document.getElementById('quickPricesHeader').addEventListener('click', () => this.toggleQuickPrices());
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                document.getElementById('priceProposalBtn').addEventListener('click', () => this.toggleFeeProposal());
                document.getElementById('submitPriceBtn').addEventListener('click', () => this.submitPriceProposal());
                document.querySelectorAll('.price-suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const price = e.target.getAttribute('data-price');
                        this.showPriceModal(price);
                    });
                });
                document.getElementById('closePriceModal').addEventListener('click', () => this.hidePriceModal());
                document.getElementById('cancelPriceBtn').addEventListener('click', () => this.hidePriceModal());
                document.getElementById('generateQRBtn').addEventListener('click', () => this.generateQRCode());
                document.getElementById('scanQRBtn').addEventListener('click', () => this.scanQRCode());
                document.getElementById('confirmPaymentBtn').addEventListener('click', () => this.confirmPayment());
                document.getElementById('closeQRModal').addEventListener('click', () => this.hideQRModal());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('navToChatsBtn').addEventListener('click', () => this.navigateToChatList());

                // QR Code functionality
                document.getElementById('downloadQRBtn').addEventListener('click', () => this.downloadQRCode());
                document.getElementById('shareQRBtn').addEventListener('click', () => this.shareQRCode());

                // QR Scanner functionality for runners
                if (this.currentRole === 'runner') {
                    document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
                    document.getElementById('uploadQRBtn').addEventListener('click', () => this.uploadQRCode());
                }
            }

            goBack() {
                // MODIFIED: Always navigate to pending.html
                window.location.href = 'pending.html';
            }

            navigateToChatList() {
                // Create chat data from this negotiation
                const chatData = this.createChatData();

                // Save to localStorage
                this.saveChatToStorage(chatData);

                // Redirect to chat list page
                window.location.href = 'chat-list.html?open_chat=' + this.errandData.errandId + '&from_negotiation=true';
            }

            createChatData() {
                // Determine counterparty name based on role
                const counterpartyName = this.currentRole === 'runner' ?
                    'Client ' + this.errandData.errandId :
                    this.errandData.runnerName;

                // Determine agreed price (use current negotiation price or agreed price)
                const agreedPrice = this.agreedPrice > 0 ? this.agreedPrice :
                    (this.currentRole === 'runner' ? this.runnerPrice : this.clientPrice);

                // Create chat data
                return {
                    id: this.errandData.errandId,
                    userName: counterpartyName,
                    avatar: counterpartyName.substring(0, 2).toUpperCase(),
                    errandType: this.errandData.errandTitle,
                    lastMessage: this.agreedPrice > 0 ?
                        `Price agreed: $${agreedPrice.toFixed(2)}` :
                        `Negotiating price: $${agreedPrice.toFixed(2)}`,
                    timestamp: 'Just now',
                    unread: 0,
                    status: this.agreedPrice > 0 ? 'active' : 'pending',
                    agreedPrice: agreedPrice,
                    messages: [
                        {
                            type: 'text',
                            sender: 'system',
                            text: this.agreedPrice > 0 ?
                                `Price negotiation completed. Agreed price: $${agreedPrice.toFixed(2)}` :
                                `Price negotiation in progress. Current offer: $${agreedPrice.toFixed(2)}`,
                            time: this.getCurrentTime()
                        }
                    ].concat(this.messages.map(msg => ({
                        type: 'text',
                        sender: msg.type === 'sent' ? this.currentRole :
                            (this.currentRole === 'runner' ? 'client' : 'runner'),
                        text: msg.text || '',
                        time: msg.time || this.getCurrentTime()
                    })))
                };
            }

            saveChatToStorage(chatData) {
                // Get existing chats
                const existingChats = JSON.parse(localStorage.getItem('errandChats') || '[]');

                // Remove existing chat with same ID if exists
                const filteredChats = existingChats.filter(chat => chat.id !== chatData.id);

                // Add new chat to beginning
                filteredChats.unshift(chatData);

                // Save back to localStorage
                localStorage.setItem('errandChats', JSON.stringify(filteredChats));

                // Show notification
                this.showNotification('Chat saved! You can continue negotiation in Chat List.');
            }

            showNotification(message) {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    max-width: 300px;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);

                // Add CSS for animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            decreaseFontSize() {
                const sizes = ['xlarge', 'large', 'medium', 'small'];
                const currentIndex = sizes.indexOf(this.currentFontSize);
                if (currentIndex < sizes.length - 1) {
                    this.currentFontSize = sizes[currentIndex + 1];
                    this.applyFontSize(this.currentFontSize);
                }
            }

            increaseFontSize() {
                const sizes = ['xlarge', 'large', 'medium', 'small'];
                const currentIndex = sizes.indexOf(this.currentFontSize);
                if (currentIndex > 0) {
                    this.currentFontSize = sizes[currentIndex - 1];
                    this.applyFontSize(this.currentFontSize);
                }
            }

            applyFontSize(size) {
                document.body.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                document.body.classList.add(`font-${size}`);
                localStorage.setItem('errandFontSize', size);
            }

            toggleQuickPrices() {
                this.quickPricesCollapsed = !this.quickPricesCollapsed;
                const quickPrices = document.getElementById('quickPrices');
                if (this.quickPricesCollapsed) {
                    quickPrices.classList.add('collapsed');
                } else {
                    quickPrices.classList.remove('collapsed');
                }
            }

            updateUIForRole() {
                const isRunner = this.currentRole === 'runner';
                const container = document.getElementById('mainContainer');

                container.className = `errand-container ${this.currentRole}-view`;
                document.body.className = `${this.currentRole}-view`;

                document.getElementById('userRole').textContent = isRunner ? 'Runner' : 'Client';

                const avatar = document.getElementById('userAvatar');
                if (isRunner) {
                    avatar.src = "https://ui-avatars.com/api/?name=Runner+Smith&background=28a745&color=fff";
                } else {
                    avatar.src = "https://ui-avatars.com/api/?name=Client+User&background=28a745&color=fff";
                }

                document.getElementById('priceIcon').className = isRunner ? 'fas fa-user' : 'fas fa-running';
                document.getElementById('headerPriceLabel').textContent = isRunner ? 'Client Price: ' : 'Runner Price: ';
                document.getElementById('counterpartyPrice').textContent = isRunner ? `$${this.clientPrice.toFixed(2)}` : `$${this.runnerPrice.toFixed(2)}`;

                document.getElementById('welcomeMessage').textContent = isRunner ?
                    "You're now connected with the client! Discuss the errand details and agree on the final price." :
                    "You're now connected with your runner! Discuss the errand details and agree on the final price.";

                document.getElementById('paymentLabel').textContent = isRunner ? "Final Amount to Receive:" : "Final Amount to Pay:";

                document.getElementById('modalTitle').textContent = isRunner ? "Make Counter Offer" : "Propose New Price";
                document.getElementById('otherPartyPriceLabel').textContent = isRunner ? "Client's Preferred Price:" : "Runner's Proposed Price:";
                document.getElementById('proposalLabel').textContent = isRunner ? "Your Counter Offer:" : "Your Proposed Price:";
                document.getElementById('proposalButtonText').textContent = isRunner ? "Counter Offer" : "Propose Price";

                document.getElementById('qrModalTitle').textContent = isRunner ? "Scan QR Code" : "Payment QR Code";
                document.getElementById('qrAmountLabel').textContent = isRunner ? "Amount to Receive:" : "Amount to Pay:";
                document.getElementById('confirmButtonText').textContent = isRunner ? "Confirm Payment Received" : "Confirm Payment Sent";

                // Update errand title if we have runner name
                if (this.errandData.runnerName && !isRunner) {
                    document.getElementById('errandTitle').textContent = `${this.errandData.errandTitle} with ${this.errandData.runnerName}`;
                }
            }

            loadInitialMessages() {
                if (!this.systemMessageAdded) {
                    const welcomeMsg = this.currentRole === 'client' ?
                        "You're now connected with your runner! Discuss the errand details and agree on the final price." :
                        "You're now connected with the client! Discuss the errand details and agree on the final price.";

                    this.addSystemMessage("System: " + welcomeMsg);
                    this.systemMessageAdded = true;
                }

                // If we have a runner price from URL, show it as an initial message
                if (this.errandData.runnerPrice && this.errandData.runnerPrice > 0) {
                    setTimeout(() => {
                        if (this.currentRole === 'client') {
                            this.addMessage("Hi! I can help with your " + this.errandData.errandTitle.toLowerCase() + ". I proposed $" + this.runnerPrice + " based on the distance.", "received");
                        } else {
                            this.addMessage("I can do this for $" + this.runnerPrice + " based on the requirements.", "sent");
                        }
                    }, 1000);
                } else {
                    // Default messages
                    setTimeout(() => {
                        if (this.currentRole === 'client') {
                            this.addMessage("Hi! I need help with " + this.errandData.errandTitle.toLowerCase() + ". My budget is around $" + this.clientPrice + ".", "received");
                        } else {
                            this.addMessage("Hi! I can help with your " + this.errandData.errandTitle.toLowerCase() + ". What's your budget?", "sent");
                        }
                    }, 1000);
                }

                setTimeout(() => {
                    if (this.currentRole === 'client') {
                        this.addMessage("Thanks! The system estimate is $" + this.estimatedCost + ". Would you consider $" + (this.estimatedCost + 2) + "?", "sent");
                    } else {
                        this.addMessage("Based on the distance and time required, I can do it for $" + this.runnerPrice + ".", "sent");
                    }
                }, 3000);
            }

            toggleFeeProposal() {
                this.isProposingFee = !this.isProposingFee;
                const amountWrapper = document.getElementById('amountInputWrapper');
                const messageInput = document.getElementById('messageInput');
                const proposalBtn = document.getElementById('priceProposalBtn');

                if (this.isProposingFee) {
                    amountWrapper.style.display = 'block';
                    messageInput.style.display = 'none';
                    proposalBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                    proposalBtn.style.background = this.currentRole === 'runner' ?
                        'linear-gradient(135deg, #dc3545, #c82333)' : '#dc3545';
                    document.getElementById('amountInput').focus();
                } else {
                    amountWrapper.style.display = 'none';
                    messageInput.style.display = 'block';
                    proposalBtn.innerHTML = '<i class="fas fa-dollar-sign"></i> ' +
                        (this.currentRole === 'runner' ? 'Counter Offer' : 'Propose Price');
                    proposalBtn.style.background = this.currentRole === 'runner' ?
                        'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #28a745, #20c997)';
                    document.getElementById('amountInput').value = '';
                }
            }

            showPriceModal(prefillPrice = '') {
                document.getElementById('priceModal').classList.add('show');
                document.getElementById('proposedPrice').value = prefillPrice || '';
                document.getElementById('proposedPrice').focus();
            }

            hidePriceModal() {
                document.getElementById('priceModal').classList.remove('show');
            }

            hideQRModal() {
                document.getElementById('qrModal').classList.remove('show');
            }

            submitPriceProposal() {
                const proposedPrice = parseFloat(document.getElementById('proposedPrice').value);
                if (!proposedPrice || proposedPrice <= 0) {
                    alert('Please enter a valid price');
                    return;
                }
                this.hidePriceModal();
                this.sendPriceProposal(proposedPrice);
            }

            sendPriceProposal(price) {
                if (this.currentRole === 'client') {
                    this.clientAgreement.price = price;
                    this.clientAgreement.status = 'pending';
                } else {
                    this.runnerAgreement.price = price;
                    this.runnerAgreement.status = 'pending';
                }

                this.addAgreementBubble(price, 'sent');

                setTimeout(() => {
                    const counterPrice = price - 2;
                    if (this.currentRole === 'client') {
                        this.runnerAgreement.price = counterPrice;
                        this.runnerAgreement.status = 'pending';
                        this.addAgreementBubble(counterPrice, 'received');
                        this.addMessage("I can do $" + counterPrice + ". That works for me!", "received");
                    } else {
                        this.clientAgreement.price = counterPrice;
                        this.clientAgreement.status = 'pending';
                        this.addAgreementBubble(counterPrice, 'received');
                        this.addMessage("I can do $" + counterPrice + ". That works for me!", "received");
                    }
                }, 2000);
            }

            addAgreementBubble(price, type) {
                const messagesContainer = document.getElementById('chatMessages');
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const isSent = type === 'sent';
                const userLabel = isSent ?
                    (this.currentRole === 'client' ? 'Your Proposal' : 'Your Counter Offer') :
                    (this.currentRole === 'client' ? "Runner's Proposal" : "Client's Proposal");

                const agreementDiv = document.createElement('div');
                agreementDiv.className = `agreement-bubble ${type}`;
                agreementDiv.innerHTML = `
                    <div class="agreement-header">
                        <h4><i class="fas fa-handshake"></i> ${userLabel}</h4>
                        <span class="agreement-status pending">Pending</span>
                    </div>
                    <div class="agreed-price">
                        <span class="price-label">Proposed Price:</span>
                        <span class="price-value">$${price.toFixed(2)}</span>
                    </div>
                    <div class="agreement-actions">
                        <button class="btn btn-outline reject-btn">Reject</button>
                        <button class="btn btn-primary accept-btn">Accept</button>
                    </div>
                    <div class="message-time">${time}</div>
                `;

                messagesContainer.appendChild(agreementDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const acceptBtn = agreementDiv.querySelector('.accept-btn');
                const rejectBtn = agreementDiv.querySelector('.reject-btn');

                acceptBtn.addEventListener('click', () => {
                    this.acceptPriceProposal(price, agreementDiv);
                });

                rejectBtn.addEventListener('click', () => {
                    this.rejectPriceProposal(agreementDiv);
                });

                // Also add as regular message
                this.addMessage(`Proposed price: $${price.toFixed(2)}`, type, time);
            }

            acceptPriceProposal(price, agreementElement) {
                agreementElement.querySelector('.agreement-status').textContent = 'Accepted';
                agreementElement.querySelector('.agreement-status').className = 'agreement-status accepted';

                const buttons = agreementElement.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });

                this.agreedPrice = price;
                this.isPriceAgreed = true;

                // Show the payment section with animation
                this.showPaymentSection();

                this.addMessage("I accept the price of $" + price, "sent");

                this.addSystemMessage("Price agreed! " + (this.currentRole === 'client' ?
                    "Client can now generate payment QR code." : "Waiting for client to generate payment QR code."));
            }

            rejectPriceProposal(agreementElement) {
                agreementElement.querySelector('.agreement-status').textContent = 'Rejected';
                agreementElement.querySelector('.agreement-status').style.background = '#f8d7da';
                agreementElement.querySelector('.agreement-status').style.color = '#721c24';

                const buttons = agreementElement.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });

                this.addMessage("I'm not comfortable with that price. Can we discuss further?", "sent");
            }

            showPaymentSection() {
                const paymentSection = document.getElementById('paymentSection');
                document.getElementById('finalAmount').textContent = '$' + this.agreedPrice.toFixed(2);

                // Add the show class to trigger the animation
                setTimeout(() => {
                    paymentSection.classList.add('show');
                }, 100);
            }

            generateQRCode() {
                if (this.isPriceAgreed && this.agreedPrice > 0) {
                    if (this.currentRole === 'client') {
                        document.getElementById('qrModal').classList.add('show');
                        document.getElementById('qrAmount').textContent = '$' + this.agreedPrice.toFixed(2);

                        // Generate actual QR code
                        this.createPaymentQRCode();
                    } else {
                        alert('Only clients can generate QR codes');
                    }
                } else {
                    alert('Please agree on a price first');
                }
            }

            createPaymentQRCode() {
                const qrContainer = document.getElementById('qrCodeContainer');
                const qrPlaceholder = document.getElementById('qrPlaceholder');
                const qrActions = document.getElementById('qrActions');

                // Create payment data for QR code
                const paymentData = {
                    errandId: this.errandData.errandId,
                    runnerId: this.errandData.runnerId,
                    amount: this.agreedPrice,
                    currency: "USD",
                    timestamp: new Date().toISOString(),
                    type: "errand_payment",
                    description: this.errandData.errandTitle
                };

                // Convert to string for QR code
                const qrText = JSON.stringify(paymentData);

                // Clear placeholder and show loading
                qrPlaceholder.innerHTML = '<i class="fas fa-spinner fa-spin"></i><p>Generating QR Code...</p>';

                // Generate QR code
                QRCode.toCanvas(qrText, {
                    width: 256,
                    height: 256,
                    colorDark: "#28a745",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                }, (err, canvas) => {
                    if (err) {
                        console.error('QR generation error:', err);
                        qrPlaceholder.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to generate QR code</p>
                            <button class="btn btn-outline" onclick="errandFinalChat.createPaymentQRCode()">Retry</button>
                        `;
                        return;
                    }

                    // Add styling to canvas
                    canvas.classList.add('real-qr-code');

                    // Clear placeholder and add canvas
                    qrContainer.innerHTML = '';
                    qrContainer.appendChild(canvas);

                    // Store the canvas for download
                    this.generatedQRCode = canvas;

                    // Show download and share buttons
                    qrActions.style.display = 'flex';
                });
            }

            downloadQRCode() {
                if (this.generatedQRCode) {
                    const link = document.createElement('a');
                    link.download = `errand-payment-${this.errandData.errandId}-${this.agreedPrice}.png`;
                    link.href = this.generatedQRCode.toDataURL('image/png');
                    link.click();

                    this.addSystemMessage("QR code downloaded successfully!");
                }
            }

            shareQRCode() {
                if (this.generatedQRCode && navigator.share) {
                    this.generatedQRCode.toBlob((blob) => {
                        const file = new File([blob], `errand-payment-${this.errandData.errandId}.png`, { type: 'image/png' });
                        navigator.share({
                            title: 'Errand Payment QR Code',
                            text: `Payment QR for $${this.agreedPrice} - ${this.errandData.errandTitle}`,
                            files: [file]
                        }).then(() => {
                            this.addSystemMessage("QR code shared successfully!");
                        }).catch(console.error);
                    });
                } else {
                    // Fallback: copy image to clipboard or show download
                    this.downloadQRCode();
                }
            }

            scanQRCode() {
                if (this.currentRole === 'runner' && this.isPriceAgreed && this.agreedPrice > 0) {
                    document.getElementById('qrModal').classList.add('show');
                    document.getElementById('qrAmount').textContent = '$' + this.agreedPrice.toFixed(2);
                } else {
                    alert('Please wait for price agreement first');
                }
            }

            startCamera() {
                const scanner = document.getElementById('qrScanner');
                const placeholder = document.querySelector('.scanner-placeholder');

                placeholder.style.display = 'none';
                scanner.style.display = 'block';

                alert('Camera access would be implemented here for QR scanning');

                setTimeout(() => {
                    this.simulateQRDetection();
                }, 2000);
            }

            uploadQRCode() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    alert('QR code image processing would happen here');
                    this.simulateQRDetection();
                };
                input.click();
            }

            simulateQRDetection() {
                // Simulate reading the QR code data
                const simulatedQRData = {
                    errandId: this.errandData.errandId,
                    runnerId: this.errandData.runnerId,
                    amount: this.agreedPrice,
                    currency: "USD",
                    timestamp: new Date().toISOString(),
                    type: "errand_payment"
                };

                alert('QR Code scanned successfully!\nAmount: $' + this.agreedPrice + '\nErrand ID: ' + this.errandData.errandId);
                document.getElementById('confirmPaymentBtn').disabled = false;
            }

            confirmPayment() {
                if (this.currentRole === 'client') {
                    alert('Payment confirmed! The runner has been notified.');
                    // After payment confirmation, navigate to chat list
                    setTimeout(() => {
                        this.navigateToChatList();
                    }, 1000);
                } else {
                    alert('Payment received! Thank you for completing the errand.');
                    // After payment received, navigate to chat list
                    setTimeout(() => {
                        this.navigateToChatList();
                    }, 1000);
                }
                this.hideQRModal();
                this.addSystemMessage("Payment of $" + this.agreedPrice + " " +
                    (this.currentRole === 'client' ? "confirmed! Runner can now proceed with the errand." : "received! Thank you."));
            }

            sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const amountInput = document.getElementById('amountInput');
                let text = '';

                if (this.isProposingFee) {
                    const amount = amountInput.value;
                    if (!amount || parseFloat(amount) <= 0) {
                        alert('Please enter a valid amount');
                        return;
                    }
                    text = `I propose a fee of $${amount} for this service.`;
                    this.sendPriceProposal(parseFloat(amount));
                    this.toggleFeeProposal();
                } else {
                    text = messageInput.value.trim();
                    if (!text) return;

                    this.addMessage(text, 'sent');
                    messageInput.value = '';

                    setTimeout(() => {
                        this.simulateReply(text);
                    }, 1000 + Math.random() * 2000);
                }
            }

            addMessage(text, type, time = null) {
                const messagesContainer = document.getElementById('chatMessages');

                if (!time) {
                    time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <div class="message-text">${this.escapeHtml(text)}</div>
                    <div class="message-time">${time}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Also store in messages array for chat data
                this.messages.push({
                    type: type,
                    text: text,
                    time: time
                });
            }

            addSystemMessage(text) {
                const messagesContainer = document.getElementById('chatMessages');
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system-message';
                messageDiv.innerHTML = `
                    <div class="message-text">${this.escapeHtml(text)}</div>
                    <div class="message-time">${time}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            simulateReply(userMessage) {
                const clientReplies = [
                    "That sounds reasonable.",
                    "Let me think about that price.",
                    "I can work with that amount.",
                    "Could we discuss the details?",
                    "That works for me!",
                    "Let me check if that fits my schedule."
                ];

                const runnerReplies = [
                    "I can accommodate that price.",
                    "Let me check my availability for that amount.",
                    "That seems fair for the distance.",
                    "I can do it for that price.",
                    "Sounds good to me!",
                    "I accept your proposal."
                ];

                const replies = this.currentRole === 'client' ? runnerReplies : clientReplies;
                const randomReply = replies[Math.floor(Math.random() * replies.length)];
                this.addMessage(randomReply, 'received');
            }

            getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        let errandFinalChat;
        document.addEventListener('DOMContentLoaded', () => {
            errandFinalChat = new ErrandFinalChat();
        });
    </script>
</body>
</html>